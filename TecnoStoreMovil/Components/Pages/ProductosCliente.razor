@page "/productos"
@using TecnoStoreMovil.Services.Contrato
@using TecnoStoreMovil.Shared.DTOs
@using TecnoStoreMovil.Components.Cards   
@inject ICatalogoClient Catalogo

<div class="container py-3">
    <h3 class="mb-3"><i class="bi bi-bag"></i> Productos</h3>

    <div class="row g-2 mb-3">
        <div class="col-12 col-md-4">
            <select class="form-select" @onchange="OnCat">
                <option value="">Todas las categorías</option>
                @foreach (var c in _cats)
                {
                    <option value="@c.Id">@c.Nombre</option>
                }
            </select>
        </div>
        <div class="col-12 col-md-8">
            <input class="form-control" placeholder="Buscar por nombre o descripción..."
                   @bind="_q" @bind:event="oninput" />
        </div>
    </div>

    @if (_loading)
    {
        <div class="alert alert-info">Cargando...</div>
    }
    else if (_items.Count == 0)
    {
        <div class="alert alert-warning">No se encontraron productos.</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            @foreach (var p in _items)
            {
                <div class="col">
                    <ProductoCard Producto="p" PrimaryText="Agregar" OnPrimaryAction="AgregarAlCarrito" />

                </div>
            }
        </div>
    }
</div>

@code {
    List<CategoriaDto> _cats = new();
    List<ProductoDto> _items = new();
    int? _catId;
    string? _q;
    bool _loading;

    protected override async Task OnInitializedAsync()
    {
        _cats = await Catalogo.GetCategoriasAsync();
        await CargarAsync();
    }

    async Task CargarAsync()
    {
        _loading = true;
        _items = await Catalogo.GetProductosAsync(_catId, _q);
        _loading = false;
    }

    async Task OnCat(ChangeEventArgs e)
    {
        _catId = int.TryParse(e.Value?.ToString(), out var v) ? v : null;
        await CargarAsync();
    }

    void AgregarAlCarrito(int productId)
    {
        // TODO: Integrar con tu CarritoStore/Service (no persistente)
        // Por ahora, solo un mensaje de prueba:
        Console.WriteLine($"Agregar producto {productId} al carrito");
    }
}
